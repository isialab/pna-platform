{"version":3,"file":"shadow-dom-events-plugin.js","sources":["../../../src/components/date-picker/shadow-dom-events-plugin.ts"],"sourcesContent":["/**\n * Copyright IBM Corp. 2019, 2024\n *\n * This source code is licensed under the Apache-2.0 license found in the\n * LICENSE file in the root directory of this source tree.\n */\n\nimport { Instance as FlatpickrInstance } from 'flatpickr/dist/types/instance';\nimport { Plugin } from 'flatpickr/dist/types/options';\nimport on from '../../globals/mixins/on';\nimport Handle from '../../globals/internal/handle';\nimport { find } from '../../globals/internal/collection-helpers';\n\n/**\n * `FlatpickrInstance` with additional properties used for `carbonFlatpickrShadowDOMEventsPlugin`.\n */\nexport interface ExtendedFlatpickrInstanceShadowDOMEventsPlugin\n  extends FlatpickrInstance {\n  /**\n   * The handle for `keydown` event handler in calendar dropdown.\n   */\n  _hCDSCEDatePickerShadowDOMEventsPluginKeydown?: Handle | null;\n}\n\n/**\n * The amount of days to adjust, keyed by the key code.\n */\nconst moveDateForKeys = {\n  ArrowLeft: -1,\n  Left: -1,\n  ArrowUp: -7,\n  Up: -7,\n  ArrowRight: 1,\n  Right: 1,\n  ArrowDown: 7,\n  Down: 7,\n};\n\n/**\n * The amount of months to adjust, keyed by the key code. Used with Ctrl modifier key.\n */\nconst moveMonthForKeys = {\n  ArrowLeft: -1,\n  Left: -1,\n  ArrowUp: -12,\n  Up: -12,\n  ArrowRight: 1,\n  Right: 1,\n  ArrowDown: 12,\n  Down: 12,\n};\n\n/**\n * The number of milliseconds per day.\n */\nconst MILLISECONDS_IN_DAY = 86400000;\n\n/**\n * Adjusts the date with the given amount of days.\n *\n * @param localDate The original date.\n * @param options The options.\n * @param [options.date=0] The amount of days to adjust.\n */\nconst adjustDate = (\n  localDate: Date,\n  { date: moveDate = 0 }: { date?: number }\n) => {\n  const utcDate = new Date(\n    Date.UTC(\n      localDate.getFullYear(),\n      localDate.getMonth(),\n      localDate.getDate()\n    ) +\n      moveDate * MILLISECONDS_IN_DAY\n  );\n  return new Date(\n    utcDate.getUTCFullYear(),\n    utcDate.getUTCMonth(),\n    utcDate.getUTCDate()\n  );\n};\n\n/**\n * @returns\n *   A Flatpickr plugin to handle events.\n *   Some event handlers in Flatpickr won't work is the calendar dropdown is put in shadow DOM, due to event retargetting.\n */\nexport default (): Plugin =>\n  (fp: ExtendedFlatpickrInstanceShadowDOMEventsPlugin) => {\n    const getDateElem = (localDate) =>\n      find(\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n        fp.daysContainer!.firstElementChild!.children,\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any -- https://github.com/carbon-design-system/carbon/issues/20452\n        ({ dateObj }: any) => localDate.getTime() === dateObj.getTime()\n      );\n\n    /**\n     * Handles `keydown` event.\n     */\n    const handleKeydown = (event: KeyboardEvent) => {\n      const { ctrlKey, key, target } = event;\n      if (key === 'Enter') {\n        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n        target!.dispatchEvent(\n          Object.assign(new CustomEvent('mousedown', { bubbles: true }), {\n            which: 1,\n          })\n        );\n      } else if (!ctrlKey && key in moveDateForKeys) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any -- https://github.com/carbon-design-system/carbon/issues/20452\n        const { dateObj } = target as any;\n        const movedDate = adjustDate(dateObj, { date: moveDateForKeys[key] });\n        const movedDateElem = getDateElem(movedDate);\n        if (movedDateElem) {\n          movedDateElem.focus();\n        } else {\n          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n          const innerDaysContainer = fp.daysContainer!.firstElementChild!;\n          if (\n            movedDate.getTime() <\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any -- https://github.com/carbon-design-system/carbon/issues/20452\n            (innerDaysContainer.firstElementChild as any).dateObj.getTime()\n          ) {\n            fp.changeMonth(-1);\n            // `fp.daysContainer` is updated by `fp.changeMonth()`\n            (\n              fp.daysContainer!.firstElementChild! // eslint-disable-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n                .lastElementChild as HTMLElement\n            ).focus();\n          } else if (\n            movedDate.getTime() >\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any -- https://github.com/carbon-design-system/carbon/issues/20452\n            (innerDaysContainer.lastElementChild as any).dateObj.getTime()\n          ) {\n            fp.changeMonth(1);\n            // `fp.daysContainer` is updated by `fp.changeMonth()`\n            (\n              fp.daysContainer!.firstElementChild! // eslint-disable-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n                .firstElementChild as HTMLElement\n            ).focus();\n          }\n        }\n        event.preventDefault();\n      } else if (ctrlKey && key in moveMonthForKeys) {\n        fp.changeMonth(moveMonthForKeys[key]);\n        (fp.daysContainer!.firstElementChild!.firstElementChild as HTMLElement) // eslint-disable-line @typescript-eslint/no-non-null-assertion -- https://github.com/carbon-design-system/carbon/issues/20452\n          .focus();\n        event.preventDefault();\n      }\n    };\n\n    /**\n     * Releases event listeners used in this Flatpickr plugin.\n     */\n    const release = () => {\n      if (fp._hCDSCEDatePickerShadowDOMEventsPluginKeydown) {\n        fp._hCDSCEDatePickerShadowDOMEventsPluginKeydown =\n          fp._hCDSCEDatePickerShadowDOMEventsPluginKeydown.release();\n      }\n    };\n\n    /**\n     * Sets up event listeners used for this Flatpickr plugin.\n     */\n    const init = () => {\n      release();\n      fp._hCDSCEDatePickerShadowDOMEventsPluginKeydown = on(\n        fp.calendarContainer,\n        'keydown',\n        handleKeydown\n      );\n    };\n\n    /**\n     * Registers this Flatpickr plugin.\n     */\n    const register = () => {\n      fp.loadedPlugins.push('carbonFlatpickrShadowDOMEventsPlugin');\n    };\n\n    return {\n      onReady: [register, init],\n      onDestroy: [release],\n    };\n  };\n"],"names":[],"mappings":"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"}